<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>GAEChannel View</title>
  <script type="text/javascript">
    var scheme = '';
    var channel = null;
    var socket = null;

    function init(serverURL) {
      var xhrObj = new XMLHttpRequest();

      xhrObj.open('GET', serverURL, true);
      xhrObj.send();
    }

    function loadJSAPI(serverURL) {
      var xhr = new XMLHttpRequest();
      var src = serverURL + '/_ah/channel/jsapi';

      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && (xhr.status == 304 || xhr.status == 200)) {
          eval(xhr.responseText);
          __callObjCFunction('channelInitialized', {});
        }
      };

      xhr.open('GET', src);
      xhr.send(null);
    }

    function openChannel(token) {
      channel = new goog.appengine.Channel(token);
      socket = channel.open();

      socket.onopen = __onOpen;
      socket.onclose = __onClose;
      socket.onmessage = __onMessage;
      socket.onerror = __onError;
    }

    function closeChannel() {
      if (socket) {
        socket.close();
      }
    }

    function __callObjCFunction(selector, params) {
      var href = scheme + selector;
      var query = '';

      for (var key in params) {
        if (params.hasOwnProperty(key)) {
          query += key + '=' + encodeURIComponent(params[key]) + '&';
        }
      }

      if (query.length > 0) {
        href += '?' + query;
      }

      location.href = href;
    }

    function __onOpen() {
      __callObjCFunction('onOpen', {});
    }

    function __onClose() {
      socket = null;
      __callObjCFunction('onClose', {});
    }

    function __onMessage(message) {
      __callObjCFunction('onMessage', message.data);
    }

    function __onError(error) {
      __callObjCFunction('onError', error);
    }

    function setScheme(newScheme) {
      scheme = newScheme;
    }
  </script>
</head>
<body>
</body>
</html>